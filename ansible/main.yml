- name: install terraform
  import_playbook: install_tf.yml

- name: terraform apply
  hosts: 127.0.0.1
  connection: local
  gather_facts: false
  vars_files:
    - vars.yml
  vars:
    plugin_dir: ~/.terraform.d/plugins/linux_amd64
  tasks:
    - name: ensure .terraform dir exists
      file:
        path: "{{ plugin_dir }}"
        state: directory
    - name: downloading terraform packages
      unarchive:
        dest: "{{ plugin_dir }}"
        src: https://releases.hashicorp.com/terraform-provider-aws/2.65.0/terraform-provider-aws_2.65.0_linux_amd64.zip
        remote_src: yes
    - name: create lock.json
      copy:
        dest: "{{ plugin_dir }}/lock.json"
        content: |
          {
          \t"aws": "cd3505dd3babc602e7ebfc84522494a3b924f114b6b71ff6ac25f9101d4b3cc1"
          }
    - name: create plan file
      file: path=../terraform/tfplan state=touch
    - name: ls
      command: ls "{{ plugin_dir }}"
      register: out
    - debug: var=out
    - name: "{{ terraform_action }}"
      terraform:
        force_init: "{{ force_init }}"
        project_path: ../terraform/ # required
        plan_file: tfplan
        backend_config:
          region: "us-east-1"
          bucket: "awx-nextlinker-cmdb"
          key: "terraform.tfstate"
        state: "{{ terraform_state }}" # present, absent, planned
        variables:
          webserver_ip: "{{ webserver_ip }}"

